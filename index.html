<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Habit Tracker Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#3b82f6">
  <meta name="description" content="Advanced Habit Tracker with Progress Visualization">
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/framer-motion@10/dist/framer-motion.js"></script>
  <style>
    :root {
      --health: #10b981;
      --work: #3b82f6;
      --personal: #8b5cf6;
      --other: #64748b;
    }
    
    html, body {
      margin: 0;
      padding: 0;
      background: #f8fafc;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      touch-action: pan-y;
    }
    
    .habit-health { background-color: var(--health); }
    .habit-work { background-color: var(--work); }
    .habit-personal { background-color: var(--personal); }
    .habit-other { background-color: var(--other); }
    
    @media (max-width: 640px) {
      .calendar-day {
        width: 12.5%;
        height: 0;
        padding-bottom: 12.5%;
        position: relative;
      }
      .calendar-day-content {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }
    }
    
    /* Swipe gestures */
    [data-swipe] {
      touch-action: pan-y;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel" data-presets="react,env">
    const { useState, useEffect, useRef } = React;
    const { motion, AnimatePresence } = window.Motion;
    
    // Feature detection
    const isPWA = window.matchMedia('(display-mode: standalone)').matches;
    const supportsTouch = 'ontouchstart' in window;
    
    // Helper functions
    const dateToKey = date => date.toISOString().split('T')[0];
    const getWeekDates = (date = new Date()) => {
      const day = date.getDay();
      const diff = date.getDate() - day + (day === 0 ? -6 : 1);
      return Array.from({ length: 7 }).map((_, i) => new Date(date.setDate(diff + i)));
    };
    
    const getMonthDates = (year, month) => {
      const start = new Date(year, month, 1);
      const end = new Date(year, month + 1, 0);
      const days = [];
      for (let i = 0; i < start.getDay(); i++) days.push(null);
      for (let d = 1; d <= end.getDate(); d++) days.push(new Date(year, month, d));
      return days;
    };
    
    const calculateStreak = (log) => {
      const sorted = Object.keys(log)
        .sort((a, b) => new Date(b) - new Date(a))
        .filter(key => log[key]);
      
      if (sorted.length === 0) return 0;
      
      let streak = 1;
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      
      const startDate = dateToKey(today) === sorted[0] ? today : yesterday;
      
      for (let i = 1; i < sorted.length; i++) {
        const prevDate = new Date(sorted[i-1]);
        const currentDate = new Date(sorted[i]);
        const diffDays = Math.floor((prevDate - currentDate) / (1000 * 60 * 60 * 24));
        
        if (diffDays === 1) streak++;
        else break;
      }
      
      return streak;
    };
    
    // Achievement badges
    const BADGES = {
      7: { emoji: '🥉', name: 'Bronze' },
      14: { emoji: '🥈', name: 'Silver' },
      21: { emoji: '🥇', name: 'Gold' },
      30: { emoji: '🏆', name: 'Champion' },
      60: { emoji: '💎', name: 'Diamond' },
      90: { emoji: '👑', name: 'Legend' }
    };
    
    const HabitChart = ({ habit }) => {
      const chartRef = useRef(null);
      
      useEffect(() => {
        if (!chartRef.current) return;
        
        const last7Days = Array.from({ length: 7 })
          .map((_, i) => {
            const date = new Date();
            date.setDate(date.getDate() - i);
            return dateToKey(date);
          })
          .reverse();
        
        const data = last7Days.map(date => habit.log[date] ? 1 : 0);
        
        const ctx = chartRef.current.getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: last7Days.map(d => new Date(d).toLocaleDateString(undefined, { weekday: 'short' })),
            datasets: [{
              data,
              backgroundColor: data.map(val => val ? '#10b981' : '#e2e8f0'),
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
              y: { display: false, max: 1 },
              x: { grid: { display: false } }
            }
          }
        });
      }, [habit]);
      
      return <canvas ref={chartRef} className="w-full h-12" />;
    };
    
    const HabitBadges = ({ streak }) => {
      const earnedBadges = Object.entries(BADGES)
        .filter(([days]) => streak >= parseInt(days))
        .map(([_, badge]) => badge);
      
      if (earnedBadges.length === 0) return null;
      
      return (
        <div className="flex gap-2 mt-2">
          {earnedBadges.map((badge, i) => (
            <span 
              key={i}
              className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full flex items-center gap-1"
              title={`${badge.name} Badge - ${streak} day streak`}
            >
              {badge.emoji} {badge.name}
            </span>
          ))}
        </div>
      );
    };
    
    const HabitView = ({ view, year, month, date }) => {
      switch (view) {
        case 'week':
          const weekDates = getWeekDates(date);
          return (
            <div className="grid grid-cols-7 gap-1 text-xs">
              {weekDates.map((date, i) => (
                <div key={i} className="text-center text-neutral-500 text-xs mb-1">
                  {date.toLocaleDateString(undefined, { weekday: 'narrow' })}
                  <br />
                  {date.getDate()}
                </div>
              ))}
            </div>
          );
        case 'month':
          const monthDates = getMonthDates(year, month);
          return (
            <div className="grid grid-cols-7 gap-1 text-xs">
              {monthDates.map((date, i) => date ? (
                <div key={i} className="text-center text-neutral-500">
                  {date.getDate()}
                </div>
              ) : <div key={i} />)}
            </div>
          );
        default:
          return null;
      }
    };
    
    const Habit = ({ habit, onToggle, onDelete, view, onViewChange }) => {
      const today = new Date();
      const [currentDate, setCurrentDate] = useState(today);
      const [touchStart, setTouchStart] = useState(0);
      const [touchEnd, setTouchEnd] = useState(0);
      
      const viewMonth = currentDate.getMonth();
      const viewYear = currentDate.getFullYear();
      
      const streak = calculateStreak(habit.log);
      const total = Object.values(habit.log).filter(Boolean).length;
      
      const handleToggle = (date) => {
        const key = dateToKey(date);
        const now = dateToKey(new Date());
        if (key === now) onToggle(habit.id, key);
      };
      
      const changeDate = (days) => {
        const newDate = new Date(currentDate);
        newDate.setDate(newDate.getDate() + days);
        setCurrentDate(newDate);
      };
      
      // Swipe gestures for mobile
      const handleTouchStart = (e) => {
        setTouchStart(e.targetTouches[0].clientX);
      };
      
      const handleTouchMove = (e) => {
        setTouchEnd(e.targetTouches[0].clientX);
      };
      
      const handleTouchEnd = () => {
        if (touchStart - touchEnd > 50) changeDate(7); // Swipe left - next week
        if (touchStart - touchEnd < -50) changeDate(-7); // Swipe right - previous week
      };
      
      return (
        <motion.div
          layout
          initial={{ opacity: 0, scale: 0.95 }}
          animate={{ opacity: 1, scale: 1 }}
          exit={{ opacity: 0, scale: 0.9 }}
          transition={{ duration: 0.4 }}
          className={`bg-white border border-gray-200 rounded-2xl shadow-lg p-6 w-full max-w-xl mx-auto mb-6 border-t-4 habit-${habit.category || 'other'}`}
        >
          <div className="flex justify-between items-start mb-4">
            <div>
              <h2 className="text-xl font-bold text-neutral-800">{habit.title}</h2>
              <p className="text-sm text-neutral-500">
                {total} days | 🔥 {streak} streak
              </p>
              <HabitBadges streak={streak} />
            </div>
            <div className="flex items-center gap-2">
              <select
                value={view}
                onChange={(e) => onViewChange(e.target.value)}
                className="text-sm border rounded-lg px-2 py-1 bg-white"
              >
                <option value="day">Day</option>
                <option value="week">Week</option>
                <option value="month">Month</option>
              </select>
              <button
                onClick={() => onDelete(habit.id)}
                className="text-red-500 hover:text-red-700 text-sm"
                title="Delete Habit"
              >
                🗑
              </button>
            </div>
          </div>
          
          <HabitChart habit={habit} />
          
          <div 
            className="mt-4"
            onTouchStart={handleTouchStart}
            onTouchMove={handleTouchMove}
            onTouchEnd={handleTouchEnd}
            data-swipe
          >
            <div className="flex justify-between items-center mb-2">
              <button
                onClick={() => changeDate(-7)}
                className="px-2 py-1 bg-neutral-100 hover:bg-neutral-200 rounded-full text-neutral-700 text-sm"
              >
                ◀
              </button>
              <span className="text-sm font-semibold text-neutral-700">
                {currentDate.toLocaleDateString(undefined, { 
                  month: 'long', 
                  year: 'numeric',
                  ...(view === 'week' ? { day: 'numeric' } : {})
                })}
              </span>
              <button
                onClick={() => changeDate(7)}
                className="px-2 py-1 bg-neutral-100 hover:bg-neutral-200 rounded-full text-neutral-700 text-sm"
              >
                ▶
              </button>
            </div>
            
            <HabitView 
              view={view} 
              year={viewYear} 
              month={viewMonth} 
              date={currentDate} 
            />
            
            <div className="grid grid-cols-7 gap-1 text-xs mt-1">
              {view === 'day' ? (
                <motion.button
                  key="today"
                  onClick={() => handleToggle(currentDate)}
                  whileTap={{ scale: 0.9 }}
                  className={`aspect-square rounded-lg transition font-semibold ${
                    habit.log[dateToKey(currentDate)] 
                      ? "bg-emerald-500 text-white shadow-inner" 
                      : "bg-amber-100 hover:bg-emerald-100 text-neutral-800"
                  }`}
                >
                  {currentDate.getDate()}
                </motion.button>
              ) : view === 'week' ? (
                getWeekDates(currentDate).map((date, i) => {
                  const dateKey = dateToKey(date);
                  const isToday = dateKey === dateToKey(new Date());
                  const marked = habit.log[dateKey];
                  return (
                    <motion.button
                      key={i}
                      onClick={() => handleToggle(date)}
                      whileTap={{ scale: 0.9 }}
                      className={`calendar-day rounded-lg transition font-semibold ${
                        marked ? "bg-emerald-500 text-white shadow-inner" :
                        isToday ? "bg-amber-100 hover:bg-emerald-100 text-neutral-800" :
                        "bg-neutral-100 text-neutral-400"
                      }`}
                    >
                      <div className="calendar-day-content flex items-center justify-center">
                        {date.getDate()}
                      </div>
                    </motion.button>
                  );
                })
              ) : (
                getMonthDates(viewYear, viewMonth).map((date, i) => {
                  if (!date) return <div key={i} />;
                  const dateKey = dateToKey(date);
                  const isToday = dateKey === dateToKey(new Date());
                  const marked = habit.log[dateKey];
                  return (
                    <motion.button
                      key={i}
                      onClick={() => handleToggle(date)}
                      whileTap={{ scale: 0.9 }}
                      className={`aspect-square rounded-lg transition font-semibold ${
                        marked ? "bg-emerald-500 text-white shadow-inner" :
                        isToday ? "bg-amber-100 hover:bg-emerald-100 text-neutral-800" :
                        "bg-neutral-100 text-neutral-400"
                      }`}
                    >
                      {date.getDate()}
                    </motion.button>
                  );
                })
              )}
            </div>
          </div>
          
          {view === 'day' && (
            <div className="mt-4">
              <textarea
                placeholder="Add notes for today..."
                className="w-full p-2 border rounded-lg text-sm"
                value={habit.notes?.[dateToKey(currentDate)] || ''}
                onChange={(e) => {
                  const key = dateToKey(currentDate);
                  onToggle(habit.id, key, e.target.value);
                }}
              />
            </div>
          )}
        </motion.div>
      );
    };
    
    const App = () => {
      const [habits, setHabits] = useState(() => {
        try {
          const stored = localStorage.getItem("habits");
          return stored ? JSON.parse(stored) : [];
        } catch (e) {
          return [];
        }
      });
      
      const [view, setView] = useState('day');
      const [searchQuery, setSearchQuery] = useState('');
      const [deferredInstallPrompt, setDeferredInstallPrompt] = useState(null);
      
      useEffect(() => {
        localStorage.setItem("habits", JSON.stringify(habits));
        
        // PWA installation prompt
        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          setDeferredInstallPrompt(e);
        });
        
        // Offline detection
        window.addEventListener('offline', () => {
          console.log("App is offline");
        });
        
        return () => {
          window.removeEventListener('beforeinstallprompt', () => {});
          window.removeEventListener('offline', () => {});
        };
      }, [habits]);
      
      const addHabit = (title, category = 'other') => {
        if (!title.trim()) return;
        const newHabit = { 
          id: Date.now(), 
          title, 
          category,
          log: {}, 
          notes: {} 
        };
        setHabits(prev => [...prev, newHabit]);
      };
      
      const toggleDate = (habitId, dateKey, note) => {
        setHabits(prev =>
          prev.map(habit =>
            habit.id === habitId
              ? { 
                  ...habit, 
                  log: { 
                    ...habit.log, 
                    [dateKey]: note !== undefined ? habit.log[dateKey] : !habit.log[dateKey] 
                  },
                  notes: note !== undefined 
                    ? { ...habit.notes, [dateKey]: note } 
                    : habit.notes
                }
              : habit
          )
        );
      };
      
      const deleteHabit = (habitId) => {
        setHabits(prev => prev.filter(h => h.id !== habitId));
      };
      
      const markAllToday = () => {
        const todayKey = dateToKey(new Date());
        setHabits(prev =>
          prev.map(habit => ({
            ...habit,
            log: { ...habit.log, [todayKey]: true }
          }))
        );
      };
      
      const filteredHabits = habits.filter(habit =>
        habit.title.toLowerCase().includes(searchQuery.toLowerCase())
      );
      
      const promptInstall = () => {
        if (deferredInstallPrompt) {
          deferredInstallPrompt.prompt();
          deferredInstallPrompt.userChoice.then(choice => {
            if (choice.outcome === 'accepted') {
              console.log('User accepted install');
            }
            setDeferredInstallPrompt(null);
          });
        }
      };
      
      return (
        <div className="min-h-screen px-4 py-6">
          <div className="max-w-3xl mx-auto space-y-8">
            <header className="text-center">
              <h1 className="text-4xl font-bold text-neutral-800 mb-2">Habit Tracker Pro</h1>
              <p className="text-neutral-500">Track your habits. Stay consistent.</p>
            </header>
            
            <div className="flex flex-col sm:flex-row gap-2 justify-between items-center">
              <div className="flex gap-2 w-full">
                <input
                  type="text"
                  placeholder="Search habits..."
                  className="px-4 py-2 border rounded-lg w-full"
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                />
                <button
                  onClick={markAllToday}
                  className="px-4 py-2 bg-blue-500 text-white rounded-lg whitespace-nowrap"
                >
                  Mark All Today
                </button>
              </div>
              
              {!isPWA && deferredInstallPrompt && (
                <button
                  onClick={promptInstall}
                  className="px-4 py-2 bg-green-500 text-white rounded-lg whitespace-nowrap"
                >
                  Install App
                </button>
              )}
            </div>
            
            <div className="flex gap-2">
              <input
                type="text"
                id="habitInput"
                placeholder="Add a new habit..."
                className="px-4 py-2 border rounded-lg flex-grow"
                onKeyDown={(e) => {
                  if (e.key === 'Enter') {
                    addHabit(e.target.value);
                    e.target.value = '';
                  }
                }}
              />
              <select
                id="habitCategory"
                className="px-4 py-2 border rounded-lg"
                onChange={(e) => {
                  const input = document.getElementById('habitInput');
                  if (input.value.trim()) {
                    addHabit(input.value, e.target.value);
                    input.value = '';
                  }
                }}
              >
                <option value="health">Health</option>
                <option value="work">Work</option>
                <option value="personal">Personal</option>
                <option value="other">Other</option>
              </select>
            </div>
            
            <AnimatePresence>
              {filteredHabits.length === 0 ? (
                <motion.p
                  key="empty"
                  initial={{ opacity: 0, y: 10 }}
                  animate={{ opacity: 1, y: 0 }}
                  exit={{ opacity: 0, y: -10 }}
                  className="text-center text-neutral-400 italic"
                >
                  {searchQuery ? 'No matching habits found' : 'No habits yet. Add one above!'}
                </motion.p>
              ) : (
                filteredHabits.map(habit => (
                  <Habit
                    key={habit.id}
                    habit={habit}
                    onToggle={toggleDate}
                    onDelete={deleteHabit}
                    view={view}
                    onViewChange={setView}
                  />
                ))
              )}
            </AnimatePresence>
          </div>
        </div>
      );
    };
    
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
    
    // Service Worker registration for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').then(
          registration => {
            console.log('ServiceWorker registration successful');
          }, 
          err => {
            console.log('ServiceWorker registration failed: ', err);
          }
        );
      });
    }
  </script>
  
  <!-- Manifest for PWA -->
  <script type="application/json" id="manifest">
    {
      "name": "Habit Tracker Pro",
      "short_name": "HabitPro",
      "start_url": ".",
      "display": "standalone",
      "background_color": "#f8fafc",
      "theme_color": "#3b82f6",
      "description": "Advanced habit tracking application",
      "icons": [
        {
          "src": "icon-192.png",
          "sizes": "192x192",
          "type": "image/png"
        },
        {
          "src": "icon-512.png",
          "sizes": "512x512",
          "type": "image/png"
        }
      ]
    }
  </script>
  
  <noscript>
    <div class="nojs-message">
      <h1>Habit Tracker Pro</h1>
      <p>This application requires JavaScript to function. Please enable JavaScript in your browser settings.</p>
    </div>
  </noscript>
</body>
</html>